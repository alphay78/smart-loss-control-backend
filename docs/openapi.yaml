openapi: 3.0.0
info:
  title: Smart Loss Control API
  version: 1.0.1
  description: |
    Backend API for Smart Loss Control (Web MVP).
    Fully aligned with PRD v1.0 (Owner/Staff onboarding, inventory, offline sales, AI reconciliation, alerts, deviation reports).

servers:
  - url: http://localhost:5000
    description: Local Development Server

tags:
  - name: Auth
    description: Authentication & Staff onboarding
  - name: Inventory
    description: Inventory management, restock, and decant
  - name: Sales
    description: Offline sales sync endpoints
  - name: Audit
    description: Verification count and loss detection
  - name: Alerts
    description: Alerts generated by audits/restock mismatch
  - name: Reports
    description: Deviation and financial reports for owners/auditors
  - name: Health
    description: Server status and uptime

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    ErrorResponse:
      type: object
      properties:
        success:
          type: boolean
          example: false
        message:
          type: string
          example: "Invalid credentials"

    AuthRequest:
      type: object
      required:
        - phone
        - pin
      properties:
        phone:
          type: string
          example: "+251911123456"
        pin:
          type: string
          example: "1234"

    AuthResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        token:
          type: string
          example: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."

    StaffLinkRequest:
      type: object
      required:
        - device_id
        - qr_code
      properties:
        device_id:
          type: string
          example: "device-xyz-123"
        qr_code:
          type: string
          example: "QR123456"

    StaffLinkResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        message:
          type: string
          example: Staff device linked successfully
        device_id:
          type: string
          example: "device-xyz-123"

    SKU:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        brand:
          type: string
        size:
          type: string
        price:
          type: number
        quantity:
          type: integer

    InventoryUpdateRequest:
      type: object
      properties:
        sku_id:
          type: string
          format: uuid
        quantity:
          type: integer

    AuditVerifyResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        expected_qty:
          type: integer
          example: 97
        actual_qty:
          type: integer
          example: 95
        deviation:
          type: integer
          example: -2
        deviation_percent:
          type: number
          example: -2.06
        alert_triggered:
          type: boolean
          example: true
        estimated_loss:
          type: number
          example: 37000

    DeviationReportResponse:
      type: object
      properties:
        sku_id:
          type: string
          format: uuid
        brand:
          type: string
        size:
          type: string
        expected_qty:
          type: integer
        actual_qty:
          type: integer
        deviation:
          type: integer
        estimated_loss:
          type: number
        timestamp:
          type: string
          format: date-time

paths:
  # -------------------------
  # AUTH
  # -------------------------
  /auth/login-pin:
    post:
      summary: Staff login via PIN
      tags: [Auth]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AuthRequest"
      responses:
        "200":
          description: Successful login
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthResponse"
        "400":
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /auth/staff-link:
    post:
      summary: Link a staff device via QR scan
      tags: [Auth]
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/StaffLinkRequest"
      responses:
        "201":
          description: Staff device linked successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StaffLinkResponse"
        "400":
          description: Invalid QR or device
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  # -------------------------
  # INVENTORY
  # -------------------------
  /skus:
    get:
      summary: List all SKUs
      tags: [Inventory]
      security:
        - BearerAuth: []
      responses:
        "200":
          description: SKU list
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/SKU"

  /inventory/restock:
    post:
      summary: Restock inventory
      tags: [Inventory]
      security:
        - BearerAuth: []
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/InventoryUpdateRequest"
      responses:
        "200":
          description: Restock successful
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/InventoryUpdateRequest"

  /inventory/decant:
    post:
      summary: Decant cartons into units
      tags: [Inventory]
      security:
        - BearerAuth: []
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/InventoryUpdateRequest"
      responses:
        "200":
          description: Decant successful
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/InventoryUpdateRequest"

  # -------------------------
  # SALES
  # -------------------------
  /sales/sync:
    post:
      summary: Sync offline sales
      tags: [Sales]
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: array
              items:
                $ref: "#/components/schemas/InventoryUpdateRequest"
      responses:
        "200":
          description: Sales synced successfully

  # -------------------------
  # AUDIT
  # -------------------------
  /audit/verify:
    post:
      summary: Verify SKU counts and detect deviation
      tags: [Audit]
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/InventoryUpdateRequest"
      responses:
        "200":
          description: Verification result
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuditVerifyResponse"

  # -------------------------
  # ALERTS
  # -------------------------
  /alerts:
    get:
      summary: List all alerts
      tags: [Alerts]
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Alert list
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/AuditVerifyResponse"

  /alerts/{id}/resolve:
    patch:
      summary: Resolve an alert
      tags: [Alerts]
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Alert resolved
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string

  # -------------------------
  # REPORTS
  # -------------------------
  /reports/deviation:
    get:
      summary: Fetch SKU deviations and estimated financial loss
      tags: [Reports]
      security:
        - BearerAuth: []
      parameters:
        - name: shop_id
          in: query
          required: true
          schema:
            type: string
            format: uuid
        - name: start_date
          in: query
          required: false
          schema:
            type: string
            format: date
        - name: end_date
          in: query
          required: false
          schema:
            type: string
            format: date
      responses:
        "200":
          description: Deviation report
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/DeviationReportResponse"

  # -------------------------
  # HEALTH
  # -------------------------
  /health:
    get:
      summary: Server health check
      tags: [Health]
      responses:
        "200":
          description: Server status
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  uptime:
                    type: string
                    example: "12 days 4 hours"
                  timestamp:
                    type: string
                    format: date-time
                    example: "2026-02-16T08:00:00Z"
